<!DOCTYPE html>
<html lang="fr-fr">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.18" />
  <meta name="author" content="Claude Defrance">
  

  <link rel="stylesheet" href="/css/highlight.min.css">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/academicons.min.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700|Merriweather|Roboto+Mono">
  <link rel="stylesheet" href="/css/hugo-academic.css">
  
  <link rel="stylesheet" href="/css/infores-sn.css">
  

  <link rel="alternate" href="https://infores-sn.github.io/index.xml" type="application/rss+xml" title="{Pervasion} numérique">
  <link rel="feed" href="https://infores-sn.github.io/index.xml" type="application/rss+xml" title="{Pervasion} numérique">

  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/apple-touch-icon.png">

  <link rel="canonical" href="https://infores-sn.github.io/post/bitwise-hack/">

  

  <title>Astuce binaire : extraire la valeur d&#39;un bit en C | {Pervasion} numérique</title>

</head>
<body id="top" data-spy="scroll" data-target="#navbar-main" data-offset="71">

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">{Pervasion} numérique</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        
        <li class="nav-item">
          <a href="/#about">
            Accueil
          </a>
        </li>
        
        <li class="nav-item">
          <a href="/#posts">
            Blog
          </a>
        </li>
        
        <li class="nav-item">
          <a href="/#teaching">
            Enseignement
          </a>
        </li>
        
        <li class="nav-item">
          <a href="/#contact">
            Contact
          </a>
        </li>
        
      </ul>

    </div>
  </div>
</nav>

<div class="container">

  <article class="article" itemscope itemtype="http://schema.org/Article">

    

    <h1 itemprop="name">Astuce binaire : extraire la valeur d&#39;un bit en C</h1>

    

<div class="article-metadata">

  <span class="article-date">
    <time datetime="2017-01-06 17:13:37 &#43;0000 UTC" itemprop="datePublished">
       6 January 2017
    </time>
  </span>

  
  
  
  <span class="article-tags">
    <i class="fa fa-tags"></i>
    
    <a class="article-tag-link" href="https://infores-sn.github.io/tags/bitwise">bitwise</a
    >, 
    
    <a class="article-tag-link" href="https://infores-sn.github.io/tags/tip">tip</a
    >
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https%3a%2f%2finfores-sn.github.io%2fpost%2fbitwise-hack%2f"
         target="_blank">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Astuce%20binaire%20%3a%20extraire%20la%20valeur%20d%27un%20bit%20en%20C&amp;url=https%3a%2f%2finfores-sn.github.io%2fpost%2fbitwise-hack%2f"
         target="_blank">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2finfores-sn.github.io%2fpost%2fbitwise-hack%2f&amp;title=Astuce%20binaire%20%3a%20extraire%20la%20valeur%20d%27un%20bit%20en%20C"
         target="_blank">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https%3a%2f%2finfores-sn.github.io%2fpost%2fbitwise-hack%2f&amp;title=Astuce%20binaire%20%3a%20extraire%20la%20valeur%20d%27un%20bit%20en%20C"
         target="_blank">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Astuce%20binaire%20%3a%20extraire%20la%20valeur%20d%27un%20bit%20en%20C&amp;body=https%3a%2f%2finfores-sn.github.io%2fpost%2fbitwise-hack%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


    <div class="article-style" itemprop="articleBody">
      <div class="paragraph">
<p>Voici une astuce découverte par hasard dans un fichier source de la librairie standard d&#8217;Arduino.</p>
</div>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>À l&#8217;occasion de la préparation d&#8217;un cours d&#8217;initiation à l&#8217;électronique traitant des registres à décalage, je suis tombé sur une astuce de manipulation de bits que je n&#8217;avais jamais rencontrée. Celle-ci vise à extraire la valeur d&#8217;un bit du contenu d&#8217;une variable.</p>
</div>
<div class="paragraph">
<p>Cette astuce est utilisée dans le code source de la fonction <code>shiftOut()</code> disponible dans le fichier <code>wiring_shift.c</code> (&#8594; répertoire <code>Contents/Java/hardware/arduino/avr/cores/arduino</code> du paquet <code>Arduino.app</code> sous Mac OSX). Elle apparaît au niveau de la spécification du 2<sup>ième</sup> argument des fonctions <code>digitalWrite()</code> contenues dans le bloc <code>if&#8230;&#8203;else&#8230;&#8203;</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight nowrap"><code class="language-c" data-lang="c">void shiftOut(uint8_t dataPin, uint8_t clockPin, uint8_t bitOrder, uint8_t val)
{
   uint8_t i;

   for (i = 0; i &lt; 8; i++)  {
      if (bitOrder == LSBFIRST)
         digitalWrite(dataPin, !!(val &amp; (1 &lt;&lt; i)));
         //                    ~~~~~~~~~~~~~~~~~~
      else
         digitalWrite(dataPin, !!(val &amp; (1 &lt;&lt; (7 - i))));
         //                    ~~~~~~~~~~~~~~~~~~~~~~~~

      digitalWrite(clockPin, HIGH);
      digitalWrite(clockPin, LOW);
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette fonction consiste à envoyer sur la broche <code>dataPin</code> de l&#8217;Arduino et les unes après les autres, les valeurs des 8 bits d&#8217;un octet <code>val</code> (on parle aussi de <strong>sérialisation</strong> de l&#8217;octet). L&#8217;ordre dans lequel les bits sont envoyés est déterminé par le paramètre <code>bitOrder</code> (<code>LSBFIRST</code> &#8594; bit de poids faible en 1<sup>ier</sup>). Chaque envoi de bit sur la broche <code>dataPin</code> est enfin signalé par l&#8217;émission d&#8217;une impulsion sur la broche <code>clockPin</code>.</p>
</div>
<div class="paragraph">
<p>Le schéma ci-dessous illustre un cas typique d&#8217;utilisation de la fonction <code>shiftOut()</code> dans un montage à base d&#8217;un registre à décalage <a href="http://www.nxp.com/documents/data_sheet/74HC_HCT595.pdf">74HC595</a> configuré ici en mode  <em>Serial IN - Parallel OUT</em>. Celui-ci commande simultanément les 8 broches d&#8217;entrée d&#8217;un afficheur 7 segments (signaux <code>A</code> à <code>H</code> sur le schéma) à partir des informations que l&#8217;Arduino lui fournit à travers uniquement 2 broches (<code>DS</code> pour les bits de l&#8217;octet sérialisé et <code>SH_CP</code> pour l&#8217;impulsion signalant leur mise à disposition). L&#8217;appel à un composant externe permet ainsi de libérer 6 broches sur l&#8217;Arduino pour un autre usage.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En réalité, une 3<sup>ième</sup> broche de l&#8217;Arduino est utilisée. Celle-ci est nommée LATCH sur le schéma mais vu qu&#8217;elle ne sert pas pour le processus de (dé)sérialisation de l&#8217;octet, elle n&#8217;est pas comptabilisée.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="/img/20170106/schema_74hc595.png"><img src="/img/20170106/schema_74hc595.png" alt="schema 74hc595" width="800"></a>
</div>
</div>
<div class="paragraph">
<p>Mais, revenons à l&#8217;astuce en question&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Dans le 1<sup>ier</sup> <code>digitalWrite()</code>, le 2<sup>ième</sup> argument est spécifié par l&#8217;expression <code>!!(val &amp; (1 &lt;&lt; i)</code>. Celle-ci permet de déterminer la valeur du bit de rang <code>i</code> de l&#8217;octet <code>val</code> à générer sur la broche <code>dataPin</code>.</p>
</div>
<div class="paragraph">
<p>Cette expression m&#8217;a un peu intrigué au départ car elle fait usage à la fois d&#8217;opérateurs de logique booléenne et d&#8217;opérateurs agissant sur des bits (<em>bitwise operators</em> en anglais ou &#8220;opérateurs bit à bit&#8221; en français). Le <code>!</code> correspond ainsi à la négation de l&#8217;algèbre de Boole tandis que le <code>&amp;</code> et le <code>&lt;&lt;</code> correspondent respectivement aux opérations bit à bit du ET et du décalage à gauche.</p>
</div>
<div class="paragraph">
<p>Faire intervenir des opérateurs à ce point différents dans le cadre d&#8217;une même expression doit toujours, à mon sens, susciter la défiance.</p>
</div>
<div class="paragraph">
<p>Avant de décomposer cette expression sur un cas concret afin de &#8220;démontrer&#8221; le bien fondé de l&#8217;astuce, rappelons comment, au niveau du langage C, les valeurs de vérité des propositions booléennes sont déterminées :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>sont considérées comme FAUSSES les expressions dont l&#8217;évaluation donne 0 ;</p>
</li>
<li>
<p>sont considérées comme VRAIES les expressions dont l&#8217;évaluation donne un nombre <strong>différent de 0</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Dans le cadre de la démonstration, considérons que <code>val</code> contient la valeur binaire <code>10100101</code> et que la valeur décimale de <code>i</code> est <code>2</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;évaluation de <code>(1&lt;&lt;i)</code> mène à la valeur binaire <code>00000100</code> (1 décalé de 2 positions vers la gauche).</p>
</div>
<div class="paragraph">
<p>L&#8217;évaluation de <code>(val &amp; (1 &lt;&lt; i)</code>, qui correspond à une opération dîte de <strong>masquage</strong>, mène également à la valeur binaire <code>00000100</code> ou <code>4</code> en décimal. En effet :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">   10100101
 &amp; 00000100
 ----------
   00000100</pre>
</div>
</div>
<div class="paragraph">
<p>La suite de l&#8217;évaluation portant sur la double négation est plus délicate. En effet, la négation de la valeur <code>4</code>, c&#8217;est-à-dire VRAI dans un contexte booléen, va bien nous donner 0 (&#8594; FAUX) et la négation de ce résultat va nous donner VRAI. Cependant, qu&#8217;est-ce qui nous garantit que la valeur numérique de ce VRAI sera le <code>1</code> attendu puisqu&#8217;en C le VRAI n&#8217;est qu&#8217;un nombre différent de 0 ?</p>
</div>
<div class="paragraph">
<p>Je pense avoir trouvé la réponse dans le paragraphe <strong>6.5.3.3 Unary arithmetic operators</strong> de la <a href="http://www.open-std.org/jtc1/sc22/WG14/www/docs/n1256.pdf">norme ISO/IEC 9899:TC3</a> qui spécifie le langage C dans sa version C99.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The result of the logical negation operator ! is 0 if the value of its operand compares unequal to 0, 1 <strong>if the value of its operand compares equal to 0</strong>. The result has type int. The expression !E is equivalent to (0==E).</p>
</div>
</blockquote>
<div class="attribution">
&#8212; ISO/IEC 9899:TC3 - Programming languages - C
</div>
</div>
<div class="paragraph">
<p>Conformément à ce que dit la norme dans la dernière partie de la 1<sup>ière</sup> phrase, le résultat final de l&#8217;évaluation de l&#8217;ensemble de l&#8217;expression de notre exemple donnera donc bien la valeur attendue, c&#8217;est-à-dire <code>1</code>, pour le bit de rang 2 de <code>val</code> (i.e. le 3<sup>ième</sup> bit en partant de la droite) . En effet, <code>!!(val &amp; (1 &lt;&lt; i) = !!(4) = !(!(4)) = !(0) = 1</code>.</p>
</div>
<div class="paragraph">
<p>Afin d&#8217;être complet, considérons à présent un bit à 0 dans l&#8217;octet <code>val</code> en prenant <code>i = 4</code>. L&#8217;évaluation de <code>(val &amp; (1 &lt;&lt; i)</code> mène cette fois à la valeur binaire <code>00000000</code> ou simplement <code>0</code> en décimal. En effet :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">   10100101
 &amp; 00010000
 ----------
   00000000</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;ensemble de l&#8217;expression nous donne bien <code>0</code>. En effet, <code>!!(val &amp; (1 &lt;&lt; i) = !!(0) = !(!(0)) = !(1) = 0</code>.</p>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La manipulation de valeurs numériques au niveau du bit devient inévitable au fur et à mesure que l&#8217;on se rapproche du matériel (interprétation de la valeur d&#8217;un registre de composant programmable, analyse d&#8217;une trame de communication&#8230;&#8203;). De nombreuses techniques en langage C existent (voir par exemple <a href="https://community.embarcadero.com/article/technical-articles/149-tools/14514-bit-twiddling">&#8220;Bit Twiddling&#8221;</a> ou l&#8217;incontournable <a href="https://graphics.stanford.edu/~seander/bithacks.html">"Bit Twiddling Hacks"</a>).</p>
</div>
<div class="paragraph">
<p>Malgré sa simplicité apparente, l&#8217;astuce vue dans ce billet m&#8217;a intrigué la 1<sup>ière</sup> fois que je l&#8217;ai rencontrée dans la mesure où son expression considérait tour à tour ses opérandes comme des valeurs numériques puis booléennes pour enfin aboutir à une valeur numérique.</p>
</div>
<div class="paragraph">
<p>Dans l&#8217;éventualité où certains se seraient posés la même question que moi face à l&#8217;expression en langage C de cette technique de manipulation de bits, j&#8217;espère leur avoir apporté une explication satisfaisante.</p>
</div>
<table class="tableblock frame-none grid-none spread">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="red"><span class="icon"><i class="fa fa-power-off fa-2x"></i></span></span></p></td>
</tr>
</tbody>
</table>
</div>
</div>
    </div>

  </article>

  <nav>
  <ul class="pager">
    
    <li class="previous"><a href="https://infores-sn.github.io/post/why-hugo/"><span
      aria-hidden="true">&larr;</span> HUGO, le générateur de site web statique</a></li>
    

    
  </ul>
</nav>

  
<section id="comments">
  <div id="disqus_thread">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'infores-sn';
    var disqus_identifier = 'https:\/\/infores-sn.github.io\/post\/bitwise-hack\/';
    var disqus_title = 'Astuce binaire : extraire la valeur d\x27un bit en C';
    var disqus_url = 'https:\/\/infores-sn.github.io\/post\/bitwise-hack\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</section>



</div>
<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2016 Claude Defrance &middot; 

      Powered by the <a href="https://github.com/gcushen/hugo-academic" target="_blank">Academic
      theme</a> for <a href="http://gohugo.io" target="_blank">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.4/TweenMax.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/ScrollToPlugin.min.js"></script>
    <script src="/js/jquery-1.12.3.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/isotope.pkgd.min.js"></script>
    <script src="/js/hugo-academic.js"></script>
    

    

    
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    

  </body>
</html>

