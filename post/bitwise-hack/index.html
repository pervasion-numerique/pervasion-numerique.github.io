<!DOCTYPE html>
<html lang="fr-fr">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.18" />
  <meta name="author" content="Claude Defrance">
  

  <link rel="stylesheet" href="/css/highlight.min.css">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/academicons.min.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700|Merriweather|Roboto+Mono">
  <link rel="stylesheet" href="/css/hugo-academic.css">
  <link rel="stylesheet" href="/css/infores-sn.css">
  

  <link rel="alternate" href="https://infores-sn.github.io/index.xml" type="application/rss+xml" title="{Pervasion} numérique">
  <link rel="feed" href="https://infores-sn.github.io/index.xml" type="application/rss+xml" title="{Pervasion} numérique">

  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/apple-touch-icon.png">

  <link rel="canonical" href="https://infores-sn.github.io/post/bitwise-hack/">

  

  <title>Astuce binaire : extraire la valeur d&#39;un bit en C | {Pervasion} numérique</title>

</head>
<body id="top" data-spy="scroll" data-target="#navbar-main" data-offset="71">

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">{Pervasion} numérique</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        
        <li class="nav-item">
          <a href="/#about">
            Accueil
          </a>
        </li>
        
        <li class="nav-item">
          <a href="/#posts">
            Blog
          </a>
        </li>
        
        <li class="nav-item">
          <a href="/#teaching">
            Enseignement
          </a>
        </li>
        
        <li class="nav-item">
          <a href="/#contact">
            Contact
          </a>
        </li>
        
      </ul>

    </div>
  </div>
</nav>

<div class="container">

  <article class="article" itemscope itemtype="http://schema.org/Article">

    

    <h1 itemprop="name">Astuce binaire : extraire la valeur d&#39;un bit en C</h1>

    

<div class="article-metadata">

  <span class="article-date">
    <time datetime="2017-01-06 17:13:37 &#43;0000 UTC" itemprop="datePublished">
       6 January 2017
    </time>
  </span>

  
  
  
  <span class="article-tags">
    <i class="fa fa-tags"></i>
    
    <a class="article-tag-link" href="https://infores-sn.github.iotags/bitwise">bitwise</a
    >, 
    
    <a class="article-tag-link" href="https://infores-sn.github.iotags/tip">tip</a
    >
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https%3a%2f%2finfores-sn.github.io%2fpost%2fbitwise-hack%2f"
         target="_blank">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Astuce%20binaire%20%3a%20extraire%20la%20valeur%20d%27un%20bit%20en%20C&amp;url=https%3a%2f%2finfores-sn.github.io%2fpost%2fbitwise-hack%2f"
         target="_blank">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2finfores-sn.github.io%2fpost%2fbitwise-hack%2f&amp;title=Astuce%20binaire%20%3a%20extraire%20la%20valeur%20d%27un%20bit%20en%20C"
         target="_blank">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https%3a%2f%2finfores-sn.github.io%2fpost%2fbitwise-hack%2f&amp;title=Astuce%20binaire%20%3a%20extraire%20la%20valeur%20d%27un%20bit%20en%20C"
         target="_blank">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Astuce%20binaire%20%3a%20extraire%20la%20valeur%20d%27un%20bit%20en%20C&amp;body=https%3a%2f%2finfores-sn.github.io%2fpost%2fbitwise-hack%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


    <div class="article-style" itemprop="articleBody">
      <div class="paragraph">
<p>Voici une astuce découverte par hasard dans un fichier source de la librairie standard d&#8217;Arduino.</p>
</div>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>À l&#8217;occasion de la préparation d&#8217;un cours d&#8217;initiation à l&#8217;électronique traitant des registres à décalage, je suis tombé sur une astuce de manipulation de bits que je n&#8217;avais jamais rencontrée. Celle-ci vise à extraire la valeur d&#8217;un bit du contenu d&#8217;une variable.</p>
</div>
<div class="paragraph">
<p>Cette astuce apparaît aux lignes 7 et 9 du code source de la fonction <code>shiftOut()</code> disponible dans le fichier <code>wiring_shift.c</code> (&#8594; répertoire <code>/Applications/Arduino.app/Contents/Java/hardware/arduino/avr/cores/arduino</code> sous Mac OSX).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
  <td class="code"><pre>void shiftOut(uint8_t dataPin, uint8_t clockPin, uint8_t bitOrder, uint8_t val)
{
   uint8_t i;

   <span class="keyword">for</span> (i = <span class="integer">0</span>; i &lt; <span class="integer">8</span>; i++)  {
      <span class="keyword">if</span> (bitOrder == <span class="constant">LSBFIRST</span>)
         digitalWrite(dataPin, !!(val &amp; (<span class="integer">1</span> &lt;&lt; i)));
      <span class="keyword">else</span>
         digitalWrite(dataPin, !!(val &amp; (<span class="integer">1</span> &lt;&lt; (<span class="integer">7</span> - i))));

      digitalWrite(clockPin, <span class="constant">HIGH</span>);
      digitalWrite(clockPin, <span class="constant">LOW</span>);
   }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette fonction consiste à envoyer sur une broche configurable de l&#8217;Arduino (&#8594; paramètre <code>dataPin</code>) et les unes après les autres (&#8594; lignes 7 ou 9), les valeurs des bits d&#8217;un octet (&#8594; paramètre <code>val</code>). L&#8217;ordre dans lequel les bits sont envoyés est déterminé par le paramètre <code>bitOrder</code> (&#8594; valeur : <code>MSBFIRST</code> ou <code>LSBFIRST</code>). Une impulsion est générée sur une 2<sup>ième</sup> broche (&#8594; paramètre <code>clockPin</code>) à chaque fois qu&#8217;un nouveau bit de donnée est présent en sortie (&#8594; lignes 11 &amp; 12).</p>
</div>
<div class="paragraph">
<p>Le schéma ci-dessous illustre un cas typique d&#8217;utilisation de cette fonction dans un montage qui pilote un afficheur 7 segments. La broche de l&#8217;Arduino correspondante au paramètre <code>dataPin</code> (signal <code>SDI</code> sur le schéma) est reliée à la broche <code>DS</code> du registre à décalage référencé <a href="http://www.nxp.com/documents/data_sheet/74HC_HCT595.pdf">74HC595</a>. La broche du paramètre <code>clockPin</code> est quant à elle reliée à la broche <code>SH_CP</code> du <a href="http://www.nxp.com/documents/data_sheet/74HC_HCT595.pdf">74HC595</a>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="/img/20170106/schema_74hc595.png"><img src="/img/20170106/schema_74hc595.png" alt="schema 74hc595" width="800"></a>
</div>
</div>
<div class="paragraph">
<p>Mais, revenons à l&#8217;astuce en question&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>La ligne 7 du code source fait apparaître l&#8217;expression <code>!!(val &amp; (1 &lt;&lt; i)</code>. Le rôle de celle-ci est de déterminer la valeur du bit de rang <code>i</code>, donc 0 ou 1, de l&#8217;octet <code>val</code>. Ce bit est ensuite envoyé sur la broche  <code>dataPin</code> à l&#8217;aide de la fonction <code>digitalWrite()</code>.</p>
</div>
<div class="paragraph">
<p>Cette expression m&#8217;a un peu intrigué au départ car elle fait usage à la fois d&#8217;opérateurs de logique booléenne et d&#8217;opérateurs agissant sur des bits (<em>bitwise operators</em> en anglais ou &#8220;opérateurs bit à bit&#8221; en français). Le <code>!</code> correspond ainsi à la négation de l&#8217;algèbre de Boole tandis que le <code>&amp;</code> et le <code>&lt;&lt;</code> correspondent respectivement aux opérations bit à bit du ET et du décalage à gauche.</p>
</div>
<div class="paragraph">
<p>Or, faire intervenir des opérateurs à ce point différents dans le cadre d&#8217;une même expression doit toujours, à mon sens, susciter la défiance.</p>
</div>
<div class="paragraph">
<p>Avant de décomposer cette expression sur un cas concret afin de &#8220;démontrer&#8221; sa pertinence, rappelons comment, au niveau du langage C, les valeurs de vérité d&#8217;une proposition booléenne sont déterminées :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>sont considérées comme FAUSSES les expressions dont l&#8217;évaluation donne 0 ;</p>
</li>
<li>
<p>sont considérées comme VRAIES les expressions dont l&#8217;évaluation donne un nombre <strong>différent de 0</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour les besoins de la démonstration, considérons que <code>val</code> contienne la valeur binaire <code>10100101</code> et que la valeur décimale de <code>i</code> soit <code>2</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;évaluation de <code>(1&lt;&lt;i)</code> mène à la valeur binaire <code>00000100</code> (1 décalé de 2 positions vers la gauche).</p>
</div>
<div class="paragraph">
<p>L&#8217;évaluation de <code>(val &amp; (1 &lt;&lt; i)</code> mène également à la valeur binaire <code>00000100</code> ou <code>4</code> en décimal. En effet :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>   10100101
 &amp; 00000100
 ----------
   00000100</pre>
</div>
</div>
<div class="paragraph">
<p>Pour la suite de l&#8217;évaluation, il est utile de se référer au paragraphe <strong>6.5.3.3 Unary arithmetic operators</strong> de la <a href="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1124.pdf">norme ISO/IEC 9899:TC2</a> :</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The result of the logical negation operator ! is 0 if the value of its operand compares unequal to 0, 1 if the value of its operand compares equal to 0. The result has type int. The expression !E is equivalent to (0==E).</p>
</div>
</blockquote>
<div class="attribution">
&#8212; ISO/IEC 9899 - Programming languages - C
</div>
</div>
<div class="paragraph">
<p>Conformément à ce que dit la norme, le résultat final de l&#8217;évaluation de l&#8217;ensemble de l&#8217;expression donnera donc bien la valeur attendue c&#8217;est-à-dire <code>1</code> pour le bit de rang 2 de <code>val</code> (i.e. le 3<sup>ième</sup> bit en partant de la droite) . En effet, <code>!!(val &amp; (1 &lt;&lt; i) = !!(4) = !(!(4)) = !(0) = 1</code>.</p>
</div>
<div class="paragraph">
<p>Si on considère à présent que la valeur de <code>i</code> est 4, l&#8217;évaluation de <code>(val &amp; (1 &lt;&lt; i)</code> mène cette fois à la valeur binaire <code>00000000</code> ou simplement <code>0</code> en décimal. En effet :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>   10100101
 &amp; 00010000
 ----------
   00000000</pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;ensemble de l&#8217;expression vaut donc <code>0</code>. En effet, <code>!!(val &amp; (1 &lt;&lt; i) = !!(0) = !(!(0)) = !(1) = 0</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;accès aux bits d&#8217;une valeur numérique devient inévitable au fur et à mesure que l&#8217;on se rapproche du matériel (interprétation de la valeur d&#8217;un registre de composant programamble, analyse d&#8217;une trame de communication&#8230;&#8203;). De nombreuses techniques utilisant les opérateurs bit à bit du langage C existent (voir par exemple le fameux article : <a href="https://graphics.stanford.edu/~seander/bithacks.html">"Bit Twiddling Hacks"</a>). Cependant, malgré sa simplicité apparente, l&#8217;astuce vue dans ce billet m&#8217;a intrigué la 1<sup>ière</sup> fois que je l&#8217;ai rencontrée. C&#8217;est pour cette raison que j&#8217;ai décidé de partager l&#8217;analyse que j&#8217;en ai faite en espérant qu&#8217;elle serve à d&#8217;autres.</p>
</div>
<table class="tableblock frame-none grid-none spread">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="red"><span class="icon"><i class="fa fa-power-off fa-2x"></i></span></span></p></td>
</tr>
</tbody>
</table>
    </div>

  </article>

  <nav>
  <ul class="pager">
    
    <li class="previous"><a href="https://infores-sn.github.io/post/why-hugo/"><span
      aria-hidden="true">&larr;</span> HUGO, le générateur de site web statique</a></li>
    

    
  </ul>
</nav>

  


</div>
<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2016 Claude Defrance &middot; 

      Powered by the <a href="https://github.com/gcushen/hugo-academic" target="_blank">Academic
      theme</a> for <a href="http://gohugo.io" target="_blank">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.4/TweenMax.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/ScrollToPlugin.min.js"></script>
    <script src="/js/jquery-1.12.3.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/isotope.pkgd.min.js"></script>
    <script src="/js/hugo-academic.js"></script>
    

    

    
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    

  </body>
</html>

